name: "Release Flutter Wallet (Mainnet)"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Builds LOS Wallet for macOS, Linux & Windows â€” creates GitHub Release
# Triggered on merge to main (wallet changes), tags, or manual dispatch
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  push:
    branches: [main]
    paths:
      - 'flutter_wallet/**'
      - '.github/workflows/release-flutter-wallet.yml'
    tags:
      - 'wallet-v*-mainnet'
      - 'wallet-v*-mainnet.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.0-mainnet)'
        required: true
        default: '1.0.0-mainnet'

env:
  FLUTTER_VERSION: '3.38.4'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  macOS (.dmg)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-macos:
    name: "ğŸ macOS (.dmg)"
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            flutter_wallet/native/los_crypto_ffi/target
          key: macos-rust-${{ hashFiles('flutter_wallet/native/los_crypto_ffi/Cargo.lock') }}

      - name: Build Dilithium5 native library
        working-directory: flutter_wallet/native/los_crypto_ffi
        run: |
          cargo build --release
          cargo test --release -- --nocapture

      - name: Flutter pub get
        working-directory: flutter_wallet
        run: flutter pub get

      - name: Flutter build macOS
        working-directory: flutter_wallet
        run: flutter build macos --release

      - name: Bundle native library
        working-directory: flutter_wallet
        run: |
          APP="build/macos/Build/Products/Release/LOS Wallet.app"
          FRAMEWORKS="$APP/Contents/Frameworks"
          mkdir -p "$FRAMEWORKS"
          cp native/los_crypto_ffi/target/release/liblos_crypto_ffi.dylib "$FRAMEWORKS/"
          install_name_tool -id "@executable_path/../Frameworks/liblos_crypto_ffi.dylib" "$FRAMEWORKS/liblos_crypto_ffi.dylib"
          codesign --force --deep --sign - "$APP"

      - name: Create DMG
        working-directory: flutter_wallet
        run: |
          VERSION="${GITHUB_REF_NAME#wallet-v}"
          [ -z "$VERSION" ] && VERSION="${{ github.event.inputs.version }}"
          # For push-to-main (no tag), use default version
          if [ "$VERSION" = "$GITHUB_REF_NAME" ]; then VERSION="${{ github.event.inputs.version || '1.0.0-mainnet' }}"; fi
          
          mkdir -p release/dmg_staging
          cp -R "build/macos/Build/Products/Release/LOS Wallet.app" release/dmg_staging/
          ln -s /Applications release/dmg_staging/Applications
          
          cat > release/dmg_staging/README.txt << 'EOF'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘            LOS WALLET - MAINNET RELEASE                    â•‘
          â•‘            Unauthority Blockchain                          â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          INSTALLATION:
            Drag "LOS Wallet.app" to the Applications folder.
          
          FIRST RUN:
            1. Open the app from Applications
            2. If blocked: System Settings â†’ Privacy â†’ Open Anyway
            3. Wallet auto-configures Tor + Dilithium5 crypto
          EOF
          
          hdiutil create \
            -volname "LOS Wallet" \
            -srcfolder release/dmg_staging \
            -ov -format UDZO \
            "release/LOS-Wallet-${VERSION}-macos.dmg"
          
          rm -rf release/dmg_staging

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: wallet-macos
          path: flutter_wallet/release/*.dmg
          if-no-files-found: error

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  Linux (.tar.gz)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-linux:
    name: "ğŸ§ Linux (.tar.gz)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake git ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev \
            libsecret-1-dev libjsoncpp-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            flutter_wallet/native/los_crypto_ffi/target
          key: linux-rust-${{ hashFiles('flutter_wallet/native/los_crypto_ffi/Cargo.lock') }}

      - name: Build Dilithium5 native library
        working-directory: flutter_wallet/native/los_crypto_ffi
        run: |
          cargo build --release
          cargo test --release -- --nocapture

      - name: Flutter pub get
        working-directory: flutter_wallet
        run: flutter pub get

      - name: Flutter build Linux
        working-directory: flutter_wallet
        run: flutter build linux --release

      - name: Bundle native library & package
        working-directory: flutter_wallet
        run: |
          VERSION="${GITHUB_REF_NAME#wallet-v}"
          [ -z "$VERSION" ] && VERSION="${{ github.event.inputs.version }}"
          if [ "$VERSION" = "$GITHUB_REF_NAME" ]; then VERSION="${{ github.event.inputs.version || '1.0.0-mainnet' }}"; fi
          
          BUNDLE="build/linux/x64/release/bundle"
          
          # Copy .so into bundle/lib/
          cp native/los_crypto_ffi/target/release/liblos_crypto_ffi.so "$BUNDLE/lib/"
          
          # Create launcher script
          cat > "$BUNDLE/run.sh" << 'LAUNCHER'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${LD_LIBRARY_PATH}"
          exec "${SCRIPT_DIR}/flutter_wallet" "$@"
          LAUNCHER
          chmod +x "$BUNDLE/run.sh"
          
          # Create README
          cat > "$BUNDLE/README.txt" << 'EOF'
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            LOS WALLET - MAINNET RELEASE (Linux)
            Unauthority Blockchain
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          INSTALLATION:
            1. Extract this archive
            2. Run: ./run.sh
          
          The wallet automatically handles Tor and crypto setup.
          EOF
          
          # Package inside LOS-Wallet/ subfolder to prevent conflicts with validator
          mkdir -p release
          cd build/linux/x64/release
          mv bundle LOS-Wallet
          tar czf "../../../../release/LOS-Wallet-${VERSION}-linux-x64.tar.gz" LOS-Wallet/
          cd ../../../../

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: wallet-linux
          path: flutter_wallet/release/*.tar.gz
          if-no-files-found: error

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  Windows (.zip)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-windows:
    name: "ğŸªŸ Windows (.zip)"
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            flutter_wallet/native/los_crypto_ffi/target
          key: windows-rust-${{ hashFiles('flutter_wallet/native/los_crypto_ffi/Cargo.lock') }}

      - name: Build Dilithium5 native library
        working-directory: flutter_wallet/native/los_crypto_ffi
        run: |
          cargo build --release
          cargo test --release -- --nocapture

      - name: Flutter pub get
        working-directory: flutter_wallet
        run: flutter pub get

      - name: Flutter build Windows
        working-directory: flutter_wallet
        run: flutter build windows --release

      - name: Bundle native library & package
        working-directory: flutter_wallet
        shell: pwsh
        run: |
          $version = "$env:GITHUB_REF_NAME" -replace '^wallet-v',''
          if (-not $version -or $version -eq $env:GITHUB_REF_NAME) { $version = "${{ github.event.inputs.version || '1.0.0-mainnet' }}" }
          
          $bundle = "build\windows\x64\runner\Release"
          
          # Copy .dll next to the executable
          Copy-Item "native\los_crypto_ffi\target\release\los_crypto_ffi.dll" "$bundle\"
          
          # Create README
          @"
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            LOS WALLET - MAINNET RELEASE (Windows)
            Unauthority Blockchain
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          INSTALLATION:
            1. Extract this archive to its own folder
            2. Run: flutter_wallet.exe
          
          IMPORTANT: Do NOT extract into the same folder as LOS Validator.
          Each app must be in its own directory.
          "@ | Out-File -FilePath "$bundle\README.txt" -Encoding utf8
          
          # Package inside LOS-Wallet/ subfolder to prevent data/ conflicts with validator
          $staging = "release\staging\LOS-Wallet"
          New-Item -ItemType Directory -Force -Path $staging | Out-Null
          Copy-Item -Path "$bundle\*" -Destination $staging -Recurse
          New-Item -ItemType Directory -Force -Path release | Out-Null
          Compress-Archive -Path "release\staging\LOS-Wallet" -DestinationPath "release\LOS-Wallet-${version}-windows-x64.zip" -Force
          Remove-Item -Recurse -Force "release\staging"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: wallet-windows
          path: flutter_wallet/release/*.zip
          if-no-files-found: error

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  Create GitHub Release
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    name: "ğŸ“¦ Create Release"
    needs: [build-macos, build-linux, build-windows]
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version info
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG="wallet-v${VERSION}"
          elif [[ "${GITHUB_REF_NAME}" == wallet-v* ]]; then
            TAG="${GITHUB_REF_NAME}"
            VERSION="${TAG#wallet-v}"
          else
            # Push to main (no tag) â€” use default version
            VERSION="1.0.0-mainnet"
            TAG="wallet-v${VERSION}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Tag: $TAG"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List artifacts
        run: find artifacts -type f | sort

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "LOS Wallet ${{ steps.version.outputs.version }} (Mainnet)"
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            # ğŸ” LOS Wallet â€” Mainnet Release `${{ steps.version.outputs.version }}`

            **Post-Quantum Secure** wallet for the Unauthority blockchain mainnet.

            ## ğŸ“¥ Downloads

            | Platform | File | Install |
            |----------|------|---------|
            | ğŸ **macOS** | `LOS-Wallet-*-macos.dmg` | Open DMG â†’ drag to Applications |
            | ğŸ§ **Linux** | `LOS-Wallet-*-linux-x64.tar.gz` | Extract â†’ `./run.sh` |
            | ğŸªŸ **Windows** | `LOS-Wallet-*-windows-x64.zip` | Extract â†’ `flutter_wallet.exe` |

            ## âœ… What's Included

            - ğŸ” **CRYSTALS-Dilithium5** â€” Post-quantum digital signatures (compiled native library)
            - ğŸ§… **Automatic Tor** â€” Zero-config .onion connectivity (auto-installs if needed)
            - ğŸ’° **Send/Receive LOS** â€” Full transaction support
            - ğŸ”¥ **Proof-of-Burn** â€” Convert BTC/ETH to LOS
            - ğŸ“ **BIP39 Seed Phrase** â€” 24-word backup & recovery
            - ğŸ›¡ï¸ **Linear Voting** â€” Sybil-neutral stake-weighted consensus
            - âš¡ **Guaranteed Mainnet** â€” All features active (Dilithium5, slashing, PoW mining)

            ## ğŸš€ First Run

            1. Install & open the wallet
            2. The app auto-configures:
               - Downloads/connects Tor (no manual install)
               - Generates quantum-secure Dilithium5 wallet
               - Connects to mainnet via `.onion`
            3. **macOS users:** If Gatekeeper blocks â†’ right-click â†’ Open

            ## âš ï¸ Notes

            - This is the **mainnet** release â€” this is a live production release
            - All traffic routed through **Tor** automatically
            - Wallet keys are **quantum-resistant** (CRYSTALS-Dilithium5)

          files: |
            artifacts/wallet-macos/*.dmg
            artifacts/wallet-linux/*.tar.gz
            artifacts/wallet-windows/*.zip
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
